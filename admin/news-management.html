<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الأخبار</title>
    <link rel="stylesheet" href="./admin-dashboard.css">
    <link rel="stylesheet" href="./news-management.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="./js/admin-auth.js"></script>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar" role="navigation" aria-label="قائمة الملاحة الرئيسية">
            <img src="./Logo.png" alt="شعار الجمعية" class="logo">
            <nav>
                <ul role="menubar">
                    <li role="none">
                        <a href="./admin-dashboard.html" role="menuitem"><i class="fas fa-arrow-right"></i>
                            العودة للوحة التحكم
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main" role="main">
            <header class="admin-header">
                <h1><i class="fas fa-newspaper"></i> إدارة الأخبار</h1>
                <a href="../index.html" class="back-link"><i class="fas fa-globe"></i> العودة للموقع</a>
            </header>

            <section class="management-container">
                <div class="management-header">
                    <h2 style="margin: 0; color: #b28935; font-size: 22px;"><i class="fas fa-list"></i> قائمة الأخبار
                    </h2>
                    <button class="add-item-btn" onclick="openAddModal()">
                        <i class="fas fa-plus"></i> إضافة خبر جديد
                    </button>
                </div>

                <div id="itemsContainer">
                    <table class="items-table" id="itemsTable">
                        <thead>
                            <tr>
                                <th>العنوان</th>
                                <th>ملخص</th>
                                <th>Slug</th>
                                <th>تاريخ النشر</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>لا توجد أخبار حتى الآن. اضف خبر جديد للبدء!</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">إضافة خبر جديد</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="itemForm">
                <div class="form-group">
                    <label for="itemTitle">العنوان *</label>
                    <input type="text" id="itemTitle" required>
                </div>
                <div class="form-group">
                    <label for="itemSlug">Slug *</label>
                    <input type="text" id="itemSlug" required placeholder="news-title-slug">
                </div>
                <div class="form-group">
                    <label for="itemPublishedDate">تاريخ النشر *</label>
                    <input type="date" id="itemPublishedDate" required>
                </div>
                <div class="form-group">
                    <label for="itemImageFile">الصورة (اختياري)</label>
                    <input type="file" id="itemImageFile" accept="image/*">
                    <div style="margin-top: 10px; display: none;" id="imagePreviewWrap">
                        <img id="itemImagePreview" alt="معاينة الصورة"
                            style="max-width: 100%; border-radius: 12px; border: 1.5px solid #e7d7b9;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="itemExcerpt">ملخص (Excerpt) *</label>
                    <textarea id="itemExcerpt" required placeholder="ملخص قصير يظهر في القائمة..."></textarea>
                </div>
                <div class="form-group">
                    <label for="itemContent">المحتوى (Content) *</label>
                    <textarea id="itemContent" required style="min-height: 180px;"
                        placeholder="محتوى الخبر الكامل..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> حفظ
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const NEWS_API = 'https://dday-api.onrender.com/api/news';
        const token = localStorage.getItem('admin_token');

        let items = [];
        let editingItem = null;

        // تحويل تاريخ الخبر الى هذا الشكل yyyy-mm-dd
        function toDateInputValue(value) {
            if (!value) return '';
            // If ISO string, take yyyy-mm-dd; if already yyyy-mm-dd keep it.
            if (typeof value === 'string' && value.length >= 10) return value.slice(0, 10);
            try {
                const d = new Date(value);
                if (isNaN(d.getTime())) return '';
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            } catch {
                return '';
            }
        }

        // إستدعاء الأخبار من الـ APi
        async function fetchNews() {
            const res = await fetch(NEWS_API, { method: 'GET' });
            const data = await res.json().catch(() => []);
            const list = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
            return list;
        }

        // تحميل الأخبار الى الواجهه
        function loadItems() {
            const tbody = document.getElementById('itemsBody');
            const emptyState = document.getElementById('emptyState');
            const itemsContainer = document.getElementById('itemsContainer');

            tbody.innerHTML = '';

            if (items.length === 0) {
                emptyState.style.display = 'block';
                itemsContainer.querySelector('.items-table').style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                itemsContainer.querySelector('.items-table').style.display = 'table';

                items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.title}</td>
                        <td>${(item.excerpt || '').substring(0, 60)}${(item.excerpt || '').length > 60 ? '...' : ''}</td>
                        <td dir="ltr" style="text-align: left;">${item.slug || ''}</td>
                        <td>${toDateInputValue(item.published_date)}</td>
                        <td>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" onclick="openEditModal(${index})">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteItem(${index})">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // فتح نافذة إضافة خبر
        function openAddModal() {
            editingItem = null;
            document.getElementById('modalTitle').textContent = 'إضافة خبر جديد';
            document.getElementById('itemForm').reset();
            const fileEl = document.getElementById('itemImageFile');
            if (fileEl) fileEl.value = '';
            document.getElementById('imagePreviewWrap').style.display = 'none';
            document.getElementById('itemImagePreview').src = '';
            document.getElementById('itemModal').classList.add('active');
        }

        function openEditModal(index) {
            const item = items[index];
            editingItem = item;
            document.getElementById('modalTitle').textContent = 'تعديل الخبر';
            document.getElementById('itemTitle').value = item.title;
            document.getElementById('itemSlug').value = item.slug;
            document.getElementById('itemPublishedDate').value = toDateInputValue(item.published_date);
            const fileEl = document.getElementById('itemImageFile');
            if (fileEl) fileEl.value = '';
            if (item.image) {
                document.getElementById('itemImagePreview').src = item.image;
                document.getElementById('imagePreviewWrap').style.display = 'block';
            } else {
                document.getElementById('imagePreviewWrap').style.display = 'none';
                document.getElementById('itemImagePreview').src = '';
            }
            document.getElementById('itemExcerpt').value = item.excerpt;
            document.getElementById('itemContent').value = item.content;
            document.getElementById('itemModal').classList.add('active');
        }

        // إغلاق النافذة
        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            editingItem = null;
        }

        // إنشاء كائن FormData 
        function buildNewsFormData(payload, file) {
            const fd = new FormData();
            fd.append('title', payload.title);
            fd.append('published_date', payload.published_date);
            fd.append('excerpt', payload.excerpt);
            fd.append('content', payload.content);
            fd.append('slug', payload.slug);
            if (file) fd.append('image', file);
            return fd;
        }

        // إضافة خبر
        async function createNews(payload, file) {
            const res = await fetch(NEWS_API, {
                method: 'POST',
                headers: {
                    'credentials': 'include',
                    'Content-Type': 'multipart/form-data',
                    'Authorization' : `Bearer ${token}`
                },
                body: buildNewsFormData(payload, file)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || data.error || 'فشل إنشاء الخبر.');
            return (data.data || data);
        }

        // تعديل خبر
        async function updateNews(identifier, payload, file) {
            // Many APIs use PUT /api/news/:id (or :slug)
            const url = `${NEWS_API}/${encodeURIComponent(identifier)}`;
            const res = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'multipart/form-data',
                    'Authorization' : `Bearer ${token}`
                },
                body: buildNewsFormData(payload, file)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || data.error || 'فشل تحديث الخبر.');
            return (data.data || data);
        }

        async function deleteNews(identifier) {
            const url = `${NEWS_API}/${encodeURIComponent(identifier)}`;
            const res = await fetch(url, { method: 'DELETE', 
            headers: {
                'Content-Type': 'application/json',
                'Authorization' : `Bearer ${token}`
            } });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.message || data.error || 'فشل حذف الخبر.');
            }
            return true;
        }

        // إرسال الإضافة او التعديل
        document.getElementById('itemForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const payload = {
                title: document.getElementById('itemTitle').value.trim(),
                published_date: document.getElementById('itemPublishedDate').value,
                excerpt: document.getElementById('itemExcerpt').value.trim(),
                content: document.getElementById('itemContent').value.trim(),
                slug: document.getElementById('itemSlug').value.trim(),
            };
            const fileInput = document.getElementById('itemImageFile');
            const imageFile = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

            if (!payload.title || !payload.slug || !payload.published_date || !payload.excerpt || !payload.content) {
                alert('يرجى تعبئة جميع الحقول المطلوبة.');
                return;
            }

            try {
                if (!editingItem) {
                    const created = await createNews(payload, imageFile);
                    if (created) items.unshift(created);
                } else {
                    const identifier = editingItem.id || editingItem.slug;
                    if (!identifier) {
                        alert('لا يمكن تحديث هذا الخبر لعدم وجود (id) أو (slug).');
                        return;
                    }
                    const updated = await updateNews(identifier, payload, imageFile);
                    if (updated) {
                        const idx = items.findIndex(x => (x.id && x.id === editingItem.id) || (x.slug && x.slug === editingItem.slug));
                        if (idx !== -1) items[idx] = updated;
                    }
                }

                closeModal();
                loadItems();
            } catch (err) {
                alert(err && err.message ? err.message : 'حدث خطأ غير متوقع.');
            }
        });

        // معاينة الصورة عند اختيار ملف
        document.getElementById('itemImageFile').addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) {
                document.getElementById('imagePreviewWrap').style.display = 'none';
                document.getElementById('itemImagePreview').src = '';
                return;
            }
            const url = URL.createObjectURL(file);
            document.getElementById('itemImagePreview').src = url;
            document.getElementById('imagePreviewWrap').style.display = 'block';
        });

        async function deleteItem(index) {
            if (confirm('هل أنت متأكد من حذف هذا الخبر؟')) {
                const item = items[index];
                const identifier = item && (item.id || item.slug);
                if (!identifier) {
                    alert('لا يمكن حذف هذا الخبر لعدم وجود (id) أو (slug).');
                    return;
                }
                try {
                    await deleteNews(identifier);
                    items.splice(index, 1);
                    loadItems();
                } catch (err) {
                    alert(err && err.message ? err.message : 'حدث خطأ أثناء الحذف.');
                }
            }
        }

        // إغلاق النافذة عند الضغط خارجها
        document.getElementById('itemModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // تحميل الأخبار عند تحديث الموقع
        (async function init() {
            try {
                items = await fetchNews();
                loadItems();
            } catch (err) {
                alert('تعذر جلب الأخبار من الخادم.');
                items = [];
                loadItems();
            }
        })();
    </script>
</body>

</html>